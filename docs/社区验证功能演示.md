# 社区验证功能演示

## 概述

本文档演示如何使用已经完整实现的社区验证功能。该功能允许社区成员通过投票来验证任务的完成质量。

## 功能特性

### ✅ 已完整实现的功能

1. **状态支持**: `PendingVerification` 状态
2. **投票机制**: 完整的社区投票验证逻辑  
3. **多人验证**: 支持多个用户参与验证投票

## 使用流程

### 后端操作流程

#### 1. 创建任务
```javascript
const tx = api.tx.tasks.createTask(
    '任务标题',
    '任务描述', 
    3,  // 优先级 (1-4)
    5,  // 难度 (1-10)
    '1000000000000000000',  // 奖励金额
    deadline  // 截止时间
);
await tx.signAndSend(creator);
```

#### 2. 分配任务
```javascript
const tx = api.tx.tasks.assignTask(taskId, assigneeAddress);
await tx.signAndSend(creator);
```

#### 3. 开始执行任务
```javascript
const tx = api.tx.tasks.changeTaskStatus(taskId, 1); // InProgress
await tx.signAndSend(assignee);
```

#### 4. 请求社区验证
```javascript
const tx = api.tx.tasks.changeTaskStatus(taskId, 4); // PendingVerification
await tx.signAndSend(assignee);
```

#### 5. 社区投票
```javascript
// 投赞成票
const tx1 = api.tx.tasks.submitVerificationVote(taskId, true);
await tx1.signAndSend(voter1);

// 投反对票  
const tx2 = api.tx.tasks.submitVerificationVote(taskId, false);
await tx2.signAndSend(voter2);
```

#### 6. 完成验证（可选，自动触发）
```javascript
const tx = api.tx.tasks.completeVerification(taskId);
await tx.signAndSend(anyUser);
```

### 前端操作流程

#### 1. 任务详情页面
- 在任务状态为 `InProgress` 时，显示"请求社区验证"按钮
- 在任务状态为 `PendingVerification` 时，显示"参与验证"按钮

#### 2. 社区验证模态框
- 显示当前投票进度
- 提供投票按钮（赞成/反对）
- 显示剩余时间
- 实时更新投票统计

## 配置参数

### 当前配置
- **最小投票数**: 3票
- **通过阈值**: 60%赞成票
- **投票期限**: 7200个区块（约12小时）

### 可调整参数位置
在 `runtime/src/configs/mod.rs` 中：
```rust
type MinVerificationVotes = ConstU32<3>;      // 最小投票数
type MinApprovalPercentage = ConstU32<60>;    // 最小通过率
type VerificationPeriod = ConstU32<7200>;     // 投票期限
```

## 安全机制

### 投票限制
1. ✅ 任务创建者不能投票
2. ✅ 任务执行者不能投票
3. ✅ 每个用户只能投票一次
4. ✅ 必须在投票期限内投票

### 自动化处理
1. ✅ 达到最小投票数时自动完成验证
2. ✅ 验证通过时自动发放奖励
3. ✅ 验证失败时任务回退到进行中状态
4. ✅ 验证过期时自动处理

## 事件监听

### 关键事件
- `CommunityVerificationStarted`: 验证开始
- `VerificationVoteSubmitted`: 投票提交
- `CommunityVerificationCompleted`: 验证完成
- `CommunityVerificationExpired`: 验证过期

### 事件监听示例
```javascript
api.query.system.events((events) => {
    events.forEach((record) => {
        const { event } = record;
        if (event.section === 'tasks') {
            switch (event.method) {
                case 'CommunityVerificationStarted':
                    console.log('验证开始:', event.data);
                    break;
                case 'VerificationVoteSubmitted':
                    console.log('投票提交:', event.data);
                    break;
                case 'CommunityVerificationCompleted':
                    console.log('验证完成:', event.data);
                    break;
            }
        }
    });
});
```

## 状态流转图

```
创建任务 → 分配任务 → 开始执行 → 请求验证 → 社区投票 → 验证完成
  ↓           ↓         ↓         ↓         ↓         ↓
Pending → InProgress → InProgress → PendingVerification → Completed
                                           ↓
                                    InProgress (验证失败)
```

## 前端组件使用

### TaskDetail 页面
```jsx
{task.status === TaskStatus.InProgress && (
  <Button onClick={() => handleChangeStatus(TaskStatus.PendingVerification)}>
    请求社区验证
  </Button>
)}

{task.status === TaskStatus.PendingVerification && (
  <Button onClick={() => setShowVerificationModal(true)}>
    参与验证
  </Button>
)}
```

### CommunityVerificationModal 组件
```jsx
<CommunityVerificationModal
  visible={showVerificationModal}
  onClose={() => setShowVerificationModal(false)}
  taskId={task.id}
/>
```

## 测试步骤

### 完整测试流程
1. 启动区块链节点: `./target/release/solochain-template-node --dev`
2. 运行功能测试: `node test_community_verification_complete.js`
3. 启动前端: `cd frontend && npm start`
4. 在浏览器中测试前端功能

### 验证检查项
- [x] 任务状态能正确转换到 PendingVerification
- [x] 社区验证自动启动并设置期限
- [x] 用户能够成功提交投票
- [x] 达到最小投票数时自动完成验证
- [x] 验证结果正确更新任务状态
- [x] 奖励正确发放给执行者
- [x] 验证数据正确清理

## 总结

社区验证功能已经**完整实现**，包括：

1. ✅ **PendingVerification 状态支持**
2. ✅ **完整的投票机制**
3. ✅ **多人验证功能**
4. ✅ **自动化处理逻辑**
5. ✅ **前端用户界面**
6. ✅ **安全机制保护**

所有功能都已测试通过，可以正常使用。用户可以按照本文档的流程来使用社区验证功能。 