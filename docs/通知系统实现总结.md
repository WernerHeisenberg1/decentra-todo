# é€šçŸ¥ç³»ç»Ÿå®ç°æ€»ç»“

## æ¦‚è¿°

é€šçŸ¥ç³»ç»Ÿæ˜¯ä»»åŠ¡ç®¡ç†å¹³å°çš„æ ¸å¿ƒç”¨æˆ·ä½“éªŒåŠŸèƒ½ï¼Œä¸ºç”¨æˆ·æä¾›å®æ—¶ã€ä¸ªæ€§åŒ–çš„æ¶ˆæ¯é€šçŸ¥æœåŠ¡ã€‚æœ¬ç³»ç»Ÿå®ç°äº†å®Œæ•´çš„é€šçŸ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ŒåŒ…æ‹¬é€šçŸ¥åˆ›å»ºã€å­˜å‚¨ã€æ¨é€ã€è¯»å–å’Œç®¡ç†ã€‚

## ç³»ç»Ÿæ¶æ„

### 1. åç«¯æ¶æ„ (Substrate Pallet)

#### 1.1 æ ¸å¿ƒç»„ä»¶
```
pallet-notifications/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ lib.rs          # ä¸»è¦ pallet å®ç°
â”‚   â”œâ”€â”€ types.rs        # ç±»å‹å®šä¹‰
â”‚   â”œâ”€â”€ mock.rs         # æµ‹è¯•æ¨¡æ‹Ÿ
â”‚   â””â”€â”€ tests.rs        # å•å…ƒæµ‹è¯•
â””â”€â”€ Cargo.toml          # ä¾èµ–é…ç½®
```

#### 1.2 å­˜å‚¨ç»“æ„
- **UserNotifications**: ç”¨æˆ·é€šçŸ¥è¯¦æƒ…å­˜å‚¨ (åŒé‡æ˜ å°„)
- **UserNotificationList**: ç”¨æˆ·é€šçŸ¥IDåˆ—è¡¨
- **UserNotificationPreferences**: ç”¨æˆ·é€šçŸ¥åå¥½è®¾ç½®
- **NotificationStats**: é€šçŸ¥ç»Ÿè®¡æ•°æ®
- **GlobalNotifications**: ç³»ç»Ÿå…¨å±€é€šçŸ¥

#### 1.3 é€šçŸ¥ç±»å‹
```rust
pub enum NotificationType {
    TaskCreated,         // ä»»åŠ¡åˆ›å»º
    TaskAssigned,        // ä»»åŠ¡åˆ†é…
    TaskStatusChanged,   // ä»»åŠ¡çŠ¶æ€å˜æ›´
    CommunityVerification, // ç¤¾åŒºéªŒè¯
    ReputationLevelUp,   // å£°èª‰ç­‰çº§æå‡
    AchievementUnlocked, // æˆå°±è§£é”
    RewardReceived,      // å¥–åŠ±åˆ°è´¦
    SystemAnnouncement,  // ç³»ç»Ÿå…¬å‘Š
    Other,              // å…¶ä»–
}
```

### 2. å‰ç«¯æ¶æ„ (React Components)

#### 2.1 NotificationCenter ç»„ä»¶
- å®æ—¶é€šçŸ¥å±•ç¤º
- æœªè¯»æ¶ˆæ¯å¾½ç« 
- é€šçŸ¥åˆ—è¡¨ç®¡ç†
- é€šçŸ¥æ“ä½œï¼ˆæ ‡è®°å·²è¯»ã€åˆ é™¤ï¼‰

#### 2.2 ä¸»è¦åŠŸèƒ½
- WebSocket å®æ—¶ç›‘å¬
- æµè§ˆå™¨åŸç”Ÿé€šçŸ¥
- é€šçŸ¥ä¼˜å…ˆçº§æ˜¾ç¤º
- æ—¶é—´æ ¼å¼åŒ–
- é€šçŸ¥ç»Ÿè®¡é¢æ¿

## æ ¸å¿ƒåŠŸèƒ½å®ç°

### 1. é€šçŸ¥åˆ›å»ºä¸åˆ†å‘

#### 1.1 è‡ªåŠ¨é€šçŸ¥è§¦å‘
ç³»ç»Ÿé›†æˆåˆ°å„ä¸ª pallet ä¸­ï¼Œåœ¨å…³é”®äº‹ä»¶å‘ç”Ÿæ—¶è‡ªåŠ¨åˆ›å»ºé€šçŸ¥ï¼š

**ä»»åŠ¡ç³»ç»Ÿé›†æˆï¼š**
```rust
// ä»»åŠ¡åˆ›å»ºé€šçŸ¥
let _ = pallet_notifications::Pallet::<T>::on_task_created(
    &creator,
    task_id,
    task_title,
);

// ä»»åŠ¡åˆ†é…é€šçŸ¥
let _ = pallet_notifications::Pallet::<T>::on_task_assigned(
    &assignee,
    task_id,
    task_title,
);

// ä»»åŠ¡çŠ¶æ€å˜æ›´é€šçŸ¥
let _ = pallet_notifications::Pallet::<T>::on_task_status_changed(
    &user,
    task_id,
    old_status,
    new_status,
);
```

**å£°èª‰ç³»ç»Ÿé›†æˆï¼š**
```rust
// å£°èª‰ç­‰çº§æå‡é€šçŸ¥
let _ = pallet_notifications::Pallet::<T>::on_reputation_level_up(
    user,
    old_level,
    new_level,
);
```

**æˆå°±ç³»ç»Ÿé›†æˆï¼š**
```rust
// æˆå°±è§£é”é€šçŸ¥
let _ = pallet_notifications::Pallet::<T>::on_achievement_unlocked(
    user,
    achievement_id,
    achievement_name,
);
```

#### 1.2 é€šçŸ¥åå¥½è¿‡æ»¤
```rust
// æ£€æŸ¥ç”¨æˆ·é€šçŸ¥åå¥½
let preferences = UserNotificationPreferences::<T>::get(user);
if !preferences.is_enabled(&notification_type) {
    return Ok(()); // ç”¨æˆ·ç¦ç”¨äº†æ­¤ç±»é€šçŸ¥
}
```

### 2. å®æ—¶é€šçŸ¥æ¨é€

#### 2.1 äº‹ä»¶ç›‘å¬æœºåˆ¶
```rust
// å‘å‡ºå®æ—¶é€šçŸ¥äº‹ä»¶
Self::deposit_event(Event::RealtimeNotificationPushed {
    user: user.clone(),
    notification_type,
    data,
});
```

#### 2.2 å‰ç«¯å®æ—¶ç›‘å¬
```typescript
// ç›‘å¬åŒºå—é“¾äº‹ä»¶
const unsubscribe = await api.query.system.events((events) => {
    events.forEach((record) => {
        const { event } = record;
        if (event.section === 'notifications') {
            if (event.method === 'NotificationCreated') {
                // æœ‰æ–°é€šçŸ¥ï¼Œé‡æ–°è·å–é€šçŸ¥åˆ—è¡¨
                fetchNotifications();
            } else if (event.method === 'RealtimeNotificationPushed') {
                // æ˜¾ç¤ºæµè§ˆå™¨åŸç”Ÿé€šçŸ¥
                if (Notification.permission === 'granted') {
                    new Notification('æ–°é€šçŸ¥', {
                        body: `æ‚¨æœ‰æ–°çš„${notificationType}é€šçŸ¥`,
                        icon: '/favicon.ico',
                    });
                }
            }
        }
    });
});
```

### 3. é€šçŸ¥ç®¡ç†åŠŸèƒ½

#### 3.1 æ ‡è®°å·²è¯»
```rust
#[pallet::weight(10_000)]
pub fn mark_notification_read(
    origin: OriginFor<T>,
    notification_id: u32,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    let mut notification = UserNotifications::<T>::get(&who, notification_id)
        .ok_or(Error::<T>::NotificationNotFound)?;
    
    notification.is_read = true;
    notification.read_at = Some(Self::current_timestamp());
    
    UserNotifications::<T>::insert(&who, notification_id, &notification);
    
    // æ›´æ–°ç»Ÿè®¡
    NotificationStats::<T>::mutate(&who, |stats| {
        stats.total_read = stats.total_read.saturating_add(1);
        stats.unread_count = stats.unread_count.saturating_sub(1);
    });
    
    Ok(())
}
```

#### 3.2 åˆ é™¤é€šçŸ¥
```rust
#[pallet::weight(10_000)]
pub fn delete_notification(
    origin: OriginFor<T>,
    notification_id: u32,
) -> DispatchResult {
    let who = ensure_signed(origin)?;
    
    UserNotifications::<T>::remove(&who, notification_id);
    UserNotificationList::<T>::mutate(&who, |notifications| {
        notifications.retain(|&x| x != notification_id);
    });
    
    Ok(())
}
```

### 4. ç”¨æˆ·åå¥½ç®¡ç†

#### 4.1 åå¥½è®¾ç½®ç»“æ„
```rust
#[derive(Encode, Decode, Clone, PartialEq, Eq, RuntimeDebug, TypeInfo, MaxEncodedLen)]
pub struct NotificationPreferences {
    pub task_notifications: bool,
    pub community_notifications: bool,
    pub reputation_notifications: bool,
    pub achievement_notifications: bool,
    pub reward_notifications: bool,
    pub system_announcements: bool,
    pub email_notifications: bool,
    pub push_notifications: bool,
}
```

#### 4.2 åå¥½æ£€æŸ¥é€»è¾‘
```rust
impl NotificationPreferences {
    pub fn is_enabled(&self, notification_type: &NotificationType) -> bool {
        match notification_type {
            NotificationType::TaskCreated | 
            NotificationType::TaskAssigned | 
            NotificationType::TaskStatusChanged => self.task_notifications,
            NotificationType::CommunityVerification => self.community_notifications,
            NotificationType::ReputationLevelUp => self.reputation_notifications,
            NotificationType::AchievementUnlocked => self.achievement_notifications,
            NotificationType::RewardReceived => self.reward_notifications,
            NotificationType::SystemAnnouncement => self.system_announcements,
            NotificationType::Other => true,
        }
    }
}
```

## ç”¨æˆ·ç•Œé¢åŠŸèƒ½

### 1. é€šçŸ¥ä¸­å¿ƒç»„ä»¶

#### 1.1 ä¸»è¦ç‰¹æ€§
- ğŸ“± å“åº”å¼è®¾è®¡ï¼Œé€‚é…æ¡Œé¢å’Œç§»åŠ¨ç«¯
- ğŸ”” å®æ—¶æœªè¯»æ¶ˆæ¯è®¡æ•°
- ğŸ¨ ä¼˜å…ˆçº§é¢œè‰²æ ‡è¯†
- â° æ™ºèƒ½æ—¶é—´æ˜¾ç¤º
- ğŸ¯ ä¸€é”®æ ‡è®°å·²è¯»/åˆ é™¤

#### 1.2 é€šçŸ¥å±•ç¤ºæ ¼å¼
```typescript
interface Notification {
  id: number;
  type: string;
  title: string;
  content: string;
  priority: 'low' | 'medium' | 'high' | 'urgent';
  isRead: boolean;
  createdAt: number;
  readAt?: number;
  relatedData?: any;
}
```

### 2. æµè§ˆå™¨åŸç”Ÿé€šçŸ¥

#### 2.1 æƒé™è¯·æ±‚
```typescript
// è¯·æ±‚æµè§ˆå™¨é€šçŸ¥æƒé™
useEffect(() => {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}, []);
```

#### 2.2 é€šçŸ¥æ˜¾ç¤º
```typescript
// æ˜¾ç¤ºæµè§ˆå™¨é€šçŸ¥
if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('æ–°é€šçŸ¥', {
        body: `æ‚¨æœ‰æ–°çš„${notificationType}é€šçŸ¥`,
        icon: '/favicon.ico',
    });
}
```

## æ•°æ®ç»Ÿè®¡ä¸åˆ†æ

### 1. é€šçŸ¥ç»Ÿè®¡æ•°æ®
```rust
pub struct NotificationStatistics<T: Config> {
    pub total_received: u32,    // æ€»æ¥æ”¶é€šçŸ¥æ•°
    pub total_read: u32,        // æ€»å·²è¯»é€šçŸ¥æ•°
    pub total_deleted: u32,     // æ€»åˆ é™¤é€šçŸ¥æ•°
    pub unread_count: u32,      // å½“å‰æœªè¯»æ•°é‡
    pub last_notification_at: T::Moment, // æœ€åä¸€æ¬¡æ”¶åˆ°é€šçŸ¥æ—¶é—´
}
```

### 2. ç»Ÿè®¡æ›´æ–°æœºåˆ¶
- é€šçŸ¥åˆ›å»ºæ—¶è‡ªåŠ¨å¢åŠ æ¥æ”¶è®¡æ•°
- æ ‡è®°å·²è¯»æ—¶æ›´æ–°å·²è¯»è®¡æ•°å’Œæœªè¯»è®¡æ•°
- åˆ é™¤é€šçŸ¥æ—¶å¢åŠ åˆ é™¤è®¡æ•°
- å®æ—¶æ›´æ–°æœ€åé€šçŸ¥æ—¶é—´

## æ€§èƒ½ä¼˜åŒ–

### 1. å­˜å‚¨ä¼˜åŒ–
- **é€šçŸ¥æ•°é‡é™åˆ¶**: æ¯ç”¨æˆ·æœ€å¤š1000æ¡é€šçŸ¥
- **è‡ªåŠ¨æ¸…ç†**: è¶…å‡ºé™åˆ¶æ—¶è‡ªåŠ¨åˆ é™¤æœ€æ—§é€šçŸ¥
- **è¿‡æœŸæœºåˆ¶**: é€šçŸ¥14å¤©åè‡ªåŠ¨è¿‡æœŸ

### 2. æŸ¥è¯¢ä¼˜åŒ–
- **åˆ†é¡µåŠ è½½**: å‰ç«¯åªåŠ è½½æœ€æ–°20æ¡é€šçŸ¥
- **ç´¢å¼•ä¼˜åŒ–**: ä½¿ç”¨åŒé‡æ˜ å°„ä¼˜åŒ–æŸ¥è¯¢æ€§èƒ½
- **ç¼“å­˜æœºåˆ¶**: å‰ç«¯ç¼“å­˜é€šçŸ¥åˆ—è¡¨é¿å…é‡å¤æŸ¥è¯¢

### 3. å‰ç«¯ä¼˜åŒ–
- **è™šæ‹Ÿæ»šåŠ¨**: å¤„ç†å¤§é‡é€šçŸ¥åˆ—è¡¨
- **é˜²æŠ–å¤„ç†**: é¿å…é¢‘ç¹çš„APIè°ƒç”¨
- **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡æ ‡è®°å·²è¯»

## å®‰å…¨è€ƒè™‘

### 1. æƒé™æ§åˆ¶
- ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„é€šçŸ¥
- ç®¡ç†å‘˜æ‰èƒ½å‘é€ç³»ç»Ÿå…¬å‘Š
- é˜²æ­¢é€šçŸ¥å†…å®¹æ³¨å…¥æ”»å‡»

### 2. æ•°æ®éªŒè¯
- é€šçŸ¥æ ‡é¢˜å’Œå†…å®¹é•¿åº¦é™åˆ¶
- é€šçŸ¥ç±»å‹æšä¸¾éªŒè¯
- ç”¨æˆ·èº«ä»½éªŒè¯

### 3. éšç§ä¿æŠ¤
- é€šçŸ¥å†…å®¹åŠ å¯†å­˜å‚¨ï¼ˆå¯é€‰ï¼‰
- ç”¨æˆ·å¯è‡ªå®šä¹‰éšç§è®¾ç½®
- ç¬¦åˆæ•°æ®ä¿æŠ¤æ³•è§„è¦æ±‚

## æµ‹è¯•ç­–ç•¥

### 1. å•å…ƒæµ‹è¯•
- é€šçŸ¥åˆ›å»ºåŠŸèƒ½æµ‹è¯•
- åå¥½è®¾ç½®åŠŸèƒ½æµ‹è¯•
- ç»Ÿè®¡æ•°æ®æ›´æ–°æµ‹è¯•

### 2. é›†æˆæµ‹è¯•
- å¤špalleté›†æˆæµ‹è¯•
- å‰åç«¯é€šä¿¡æµ‹è¯•
- å®æ—¶é€šçŸ¥æ¨é€æµ‹è¯•

### 3. ç«¯åˆ°ç«¯æµ‹è¯•
```javascript
// æµ‹è¯•è„šæœ¬ç¤ºä¾‹
node test_notification_system.js
```

## éƒ¨ç½²é…ç½®

### 1. Runtimeé…ç½®
```rust
impl pallet_notifications::Config for Runtime {
    type RuntimeEvent = RuntimeEvent;
    type Moment = u64;
    type MaxTitleLength = ConstU32<256>;
    type MaxContentLength = ConstU32<2048>;
    type MaxUserNotifications = ConstU32<1000>;
    type MaxGlobalNotifications = ConstU32<100>;
    type NotificationRetentionPeriod = ConstU32<201600>; // 14å¤©
    type Randomness = pallet_insecure_randomness_collective_flip::Pallet<Runtime>;
}
```

### 2. å‰ç«¯é›†æˆ
```typescript
// å¯¼èˆªæ é›†æˆ
import NotificationCenter from './NotificationCenter';

// åœ¨å¯¼èˆªæ ä¸­ä½¿ç”¨
{isConnected && selectedAccount && (
    <NotificationCenter />
)}
```

## æœªæ¥æ‰©å±•è®¡åˆ’

### 1. é«˜çº§åŠŸèƒ½
- ğŸ“§ é‚®ä»¶é€šçŸ¥é›†æˆ
- ğŸ“± ç§»åŠ¨åº”ç”¨æ¨é€
- ğŸ¤– æ™ºèƒ½é€šçŸ¥åˆ†ç±»
- ğŸ“Š é«˜çº§ç»Ÿè®¡åˆ†æ

### 2. æ€§èƒ½ä¼˜åŒ–
- ğŸš€ GraphQLæŸ¥è¯¢ä¼˜åŒ–
- ğŸ’¾ Redisç¼“å­˜å±‚
- ğŸ”„ æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥å¤„ç†
- ğŸ“ˆ é€šçŸ¥èšåˆåŠŸèƒ½

### 3. ç”¨æˆ·ä½“éªŒ
- ğŸ¨ ä¸»é¢˜å®šåˆ¶
- ğŸŒ å›½é™…åŒ–æ”¯æŒ
- ğŸ”Š å£°éŸ³æé†’
- ğŸ‘ï¸ é˜…è¯»çŠ¶æ€åŒæ­¥

## æ€»ç»“

é€šçŸ¥ç³»ç»Ÿçš„æˆåŠŸå®ç°ä¸ºä»»åŠ¡ç®¡ç†å¹³å°æä¾›äº†å…³é”®çš„ç”¨æˆ·ä½“éªŒåŸºç¡€è®¾æ–½ã€‚é€šè¿‡ï¼š

âœ… **å®Œæ•´çš„åç«¯æ¶æ„**: Substrate palletæä¾›å¯é çš„æ•°æ®å­˜å‚¨å’Œä¸šåŠ¡é€»è¾‘
âœ… **å®æ—¶é€šä¿¡æœºåˆ¶**: WebSocketäº‹ä»¶ç›‘å¬ç¡®ä¿æ¶ˆæ¯åŠæ—¶é€è¾¾
âœ… **ç”¨æˆ·å‹å¥½ç•Œé¢**: Reactç»„ä»¶æä¾›ç›´è§‚çš„é€šçŸ¥ç®¡ç†ä½“éªŒ
âœ… **çµæ´»çš„é…ç½®é€‰é¡¹**: ç”¨æˆ·å¯è‡ªå®šä¹‰é€šçŸ¥åå¥½
âœ… **å…¨é¢çš„é›†æˆæ”¯æŒ**: ä¸ä»»åŠ¡ã€å£°èª‰ã€æˆå°±ç³»ç»Ÿæ— ç¼é›†æˆ

è¿™ä¸ªé€šçŸ¥ç³»ç»Ÿä¸ä»…æ»¡è¶³äº†å½“å‰çš„åŠŸèƒ½éœ€æ±‚ï¼Œè¿˜ä¸ºæœªæ¥çš„æ‰©å±•å¥ å®šäº†åšå®çš„åŸºç¡€ï¼Œæ˜¯æå‡ç”¨æˆ·å‚ä¸åº¦å’Œå¹³å°æ´»è·ƒåº¦çš„é‡è¦å·¥å…·ã€‚ 